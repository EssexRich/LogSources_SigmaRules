title: Installation of Custom Shim Databases
id: 7fa3008c-7fa3-4fa3-afa3-7fa3008c0000
status: stable
description: Detection rule for MITRE ATT&CK technique T1546.011
references:
  - https://github.com/elastic/detection-rules/blob/main/rules/windows/persistence_app_compat_shim.toml
author: elastic (via IncidentBuddy)
date: 2026-02-08
tags:
  - attack.t1546.011
logsource:
  product: windows
  service: security
detection:
  selection:
    # Original elastic detection logic
    # registry where host.os.type == "windows" and event.type == "change" and
    #   registry.path : "*\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\AppCompatFlags\\Custom\\*.sdb" and
    #   not process.executable : (
    #         "?:\\Program Files (x86)\\DesktopCentral_Agent\\*\\Setup\\NwSapSetup.exe",
    #         "?:\\$WINDOWS.~BT\\Sources\\SetupPlatform.exe",
    #         "?:\\Program Files (x86)\\SAP\\SAPsetup\\setup\\NwSapSetup.exe",
    #         "?:\\Program Files (x86)\\SAP\\SapSetup\\OnRebootSvc\\NWSAPSetupOnRebootInstSvc.exe",
    #         "?:\\Program Files (x86)\\Kaspersky Lab\\Kaspersky Security for Windows Server\\kavfs.exe",
    # 
    #         /* Crowdstrike specific exclusion as it uses NT Object paths */
    #         "\\Device\\HarddiskVolume*\\Program Files (x86)\\DesktopCentral_Agent\\*\\Setup\\NwSapSetup.exe",
    #         "\\Device\\HarddiskVolume*\\$WINDOWS.~BT\\Sources\\SetupPlatform.exe",
    #         "\\Device\\HarddiskVolume*\\Program Files (x86)\\SAP\\SAPsetup\\setup\\NwSapSetup.exe",
    #         "\\Device\\HarddiskVolume*\\Program Files (x86)\\SAP\\SapSetup\\OnRebootSvc\\NWSAPSetupOnRebootInstSvc.exe",
    #         "\\Device\\HarddiskVolume*\\Program Files (x86)\\Kaspersky Lab\\Kaspersky Security for Windows Server\\kavfs.exe"
    #   )
  condition: selection
level: medium

title: Process Created with a Duplicated Token
id: 68722bb4-6872-4872-a872-68722bb40000
status: stable
description: Detection rule for MITRE ATT&CK technique T1134.002
references:
  - https://github.com/elastic/detection-rules/blob/main/rules/windows/privilege_escalation_create_process_with_token_unpriv.toml
author: elastic (via IncidentBuddy)
date: 2026-01-28
tags:
  - attack.t1134.002
logsource:
  product: windows
  service: powershell
detection:
  selection:
    # Original elastic detection logic
    # /* This rule is only compatible with Elastic Endpoint 8.4+ */
    # 
    # process where host.os.type == "windows" and event.action == "start" and
    # 
    #  user.id : ("S-1-5-21-*", "S-1-12-1-*") and
    # 
    #  (process.Ext.effective_parent.executable regex~ """[C-Z]:\\Windows\\(System32|SysWOW64)\\[a-zA-Z0-9\-\_\.]+\.exe""" or
    #   process.Ext.effective_parent.executable : "?:\\Windows\\explorer.exe") and
    # 
    #  (
    #   process.name : ("powershell.exe", "cmd.exe", "rundll32.exe", "notepad.exe", "net.exe", "ntdsutil.exe",
    #                   "tasklist.exe", "reg.exe", "certutil.exe", "bitsadmin.exe", "msbuild.exe", "esentutl.exe") or
    # 
    #   ((process.Ext.relative_file_creation_time <= 900 or process.Ext.relative_file_name_modify_time <= 900) and
    #    not process.code_signature.status : ("trusted", "errorExpired", "errorCode_endpoint*") and
    #    not process.executable : ("?:\\Program Files\\*", "?:\\Program Files (x86)\\*"))
    #  ) and
    #  not (process.name : "rundll32.exe" and
    #       process.command_line : ("*davclnt.dll,DavSetCookie*", "*?:\\Program Files*",
    #                               "*\\Windows\\System32\\winethc.dll*", "*\\Windows\\SYSTEM32\\EDGEHTML.dll*",
    #                               "*shell32.dll,SHCreateLocalServerRunDll*")) and
    #  not startswith~(process.Ext.effective_parent.name, process.parent.name) and
    #  not (process.name : "powershell.exe" and process.parent.name : "wmiprvse.exe" and process.Ext.effective_parent.executable : "?:\\Windows\\System32\\wsmprovhost.exe") and
    #  not (process.Ext.effective_parent.executable : "?:\\Windows\\System32\\RuntimeBroker.exe" and process.parent.executable : "?:\\Windows\\System32\\sihost.exe") and
    #  not (process.Ext.effective_parent.executable : "?:\\Windows\\System32\\sethc.exe" and process.parent.executable : "?:\\Windows\\System32\\svchost.exe") and
    #  not (process.Ext.effective_parent.executable : "?:\\Windows\\explorer.exe" and
    #       process.parent.executable : ("?:\\Windows\\System32\\svchost.exe", "?:\\Windows\\System32\\msiexec.exe", "?:\\Windows\\twain_32\\*.exe"))
  condition: selection
level: medium

title: System Public IP Discovery via DNS Query
id: 5e8c2586-5e8c-4e8c-ae8c-5e8c25860000
status: stable
description: Detection rule for MITRE ATT&CK technique T1071.004
references:
  - https://github.com/elastic/detection-rules/blob/main/rules/windows/discovery_host_public_ip_address_lookup.toml
author: elastic (via IncidentBuddy)
date: 2026-02-08
tags:
  - attack.t1071.004
logsource:
  product: windows
  service: powershell
detection:
  selection:
    # Original elastic detection logic
    # network where host.os.type == "windows" and dns.question.name != null and process.name != null and
    # (
    #   process.name : ("MSBuild.exe", "mshta.exe", "wscript.exe", "powershell.exe", "pwsh.exe", "msiexec.exe", "rundll32.exe",
    #   "bitsadmin.exe", "InstallUtil.exe", "RegAsm.exe", "vbc.exe", "RegSvcs.exe", "python.exe", "regsvr32.exe", "dllhost.exe",
    #   "node.exe", "javaw.exe", "java.exe", "*.pif", "*.com") or
    # 
    #   (?process.code_signature.trusted == false or ?process.code_signature.exists == false) or
    # 
    #   ?process.code_signature.subject_name : ("AutoIt Consulting Ltd", "OpenJS Foundation", "Python Software Foundation") or
    # 
    #   ?process.executable : ("?:\\Users\\*.exe", "?:\\ProgramData\\*.exe")
    #  ) and
    #  dns.question.name :
    #          (
    #           "ip-api.com",
    #           "checkip.dyndns.org",
    #           "api.ipify.org",
    #           "api.ipify.com",
    #           "whatismyip.akamai.com",
    #           "bot.whatismyipaddress.com",
    #           "ifcfg.me",
    #           "ident.me",
    #           "ipof.in",
    #           "ip.tyk.nu",
    #           "icanhazip.com",
    #           "curlmyip.com",
    #           "wgetip.com",
    #           "eth0.me",
    #           "ipecho.net",
    #           "ip.appspot.com",
    #           "api.myip.com",
    #           "geoiptool.com",
    #           "api.2ip.ua",
    #           "api.ip.sb",
    #           "ipinfo.io",
    #           "checkip.amazonaws.com",
    #           "wtfismyip.com",
    #           "iplogger.*",
    #           "freegeoip.net",
    #           "freegeoip.app",
    #           "ipinfo.io",
    #           "geoplugin.net",
    #           "myip.dnsomatic.com",
    #           "www.geoplugin.net",
    #           "api64.ipify.org",
    #           "ip4.seeip.org",
    #           "*.geojs.io",
    #           "*portmap.io",
    #           "api.2ip.ua",
    #           "api.db-ip.com",
    #           "geolocation-db.com",
    #           "httpbin.org",
    #           "myip.opendns.com"
    #          )
  condition: selection
level: medium

title: Whoami Process Activity
id: 1c498907-1c49-4c49-ac49-1c4989070000
status: stable
description: Detection rule for MITRE ATT&CK technique T1033
references:
  - https://github.com/elastic/detection-rules/blob/main/rules/windows/discovery_whoami_command_activity.toml
author: elastic (via IncidentBuddy)
date: 2026-02-01
tags:
  - attack.t1033
logsource:
  product: windows
  service: sysmon
detection:
  selection:
    # Original elastic detection logic
    # process where host.os.type == "windows" and event.type == "start" and process.name : "whoami.exe" and
    # (
    #   (
    #     /* scoped for whoami execution under system privileges */
    #     (
    #       (
    #         user.domain : ("NT *", "* NT", "IIS APPPOOL") and
    #         user.id : ("S-1-5-18", "S-1-5-19", "S-1-5-20", "S-1-5-82-*") and
    #         not ?winlog.event_data.SubjectUserName : "*$" and
    # 
    #         /* Sysmon will always populate user.id as S-1-5-18, leading to FPs */
    #         not event.dataset : ("windows.sysmon_operational", "windows.sysmon")
    #       ) or
    #       (?process.Ext.token.integrity_level_name : "System" or ?winlog.event_data.IntegrityLevel : "System")
    #     ) and
    #     not (
    #       process.parent.name : "cmd.exe" and
    #       process.parent.args : (
    #           "chcp 437>nul 2>&1 & C:\\WINDOWS\\System32\\whoami.exe  /groups",
    #           "chcp 437>nul 2>&1 & %systemroot%\\system32\\whoami /user",
    #           "C:\\WINDOWS\\System32\\whoami.exe /groups",
    #           "*WINDOWS\\system32\\config\\systemprofile*"
    #       )
    #     ) and
    #     not (process.parent.executable : "C:\\Windows\\system32\\inetsrv\\appcmd.exe" and process.parent.args : "LIST") and
    #     not process.parent.executable : (
    #         "C:\\Program Files\\Microsoft Monitoring Agent\\Agent\\MonitoringHost.exe",
    #         "C:\\Program Files\\Cohesity\\cohesity_windows_agent_service.exe"
    #     )
    #   ) or
    #   process.parent.name : ("wsmprovhost.exe", "w3wp.exe", "wmiprvse.exe", "rundll32.exe", "regsvr32.exe")
    # )
  condition: selection
level: medium
